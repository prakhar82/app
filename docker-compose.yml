version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/postgres/init-multi-db.sql:/docker-entrypoint-initdb.d/init-multi-db.sql

  identity-service:
    build:
      context: .
      dockerfile: identity-service/Dockerfile
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/identity_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      AUTH_MODE: ${AUTH_MODE:-DEV}
      JWT_SECRET: ${JWT_SECRET:-replace-with-very-strong-32-char-secret}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-dummy}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-dummy}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:8080}
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_AUTH: ${SMTP_AUTH:-false}
      SMTP_STARTTLS_ENABLE: ${SMTP_STARTTLS_ENABLE:-false}
      MAIL_FROM: ${MAIL_FROM:-prakhar.unique@gmail.com}
      VERIFICATION_EXPIRY_MINUTES: ${VERIFICATION_EXPIRY_MINUTES:-15}
      VERIFICATION_MAX_ATTEMPTS: ${VERIFICATION_MAX_ATTEMPTS:-5}
      POSTCODE_ALLOWED_FROM: ${POSTCODE_ALLOWED_FROM:-5600}
      POSTCODE_ALLOWED_TO: ${POSTCODE_ALLOWED_TO:-5699}
    depends_on: [postgres, mailhog]

  catalog-service:
    build:
      context: .
      dockerfile: catalog-service/Dockerfile
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/catalog_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SAMPLE_EXCEL_PATH: /samples/catalog-upload.xlsx
      INVENTORY_BASE_URL: http://inventory-service:8083
    depends_on: [postgres]
    volumes:
      - ./samples:/samples

  inventory-service:
    build:
      context: .
      dockerfile: inventory-service/Dockerfile
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/inventory_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on: [postgres]

  cart-service:
    build:
      context: .
      dockerfile: cart-service/Dockerfile
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/cart_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      INVENTORY_BASE_URL: http://inventory-service:8083
    depends_on: [postgres]

  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/order_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      INVENTORY_BASE_URL: http://inventory-service:8083
      PAYMENT_BASE_URL: http://payment-service:8086
      IDENTITY_BASE_URL: http://identity-service:8081
    depends_on: [postgres, inventory-service, payment-service]

  payment-service:
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/payment_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on: [postgres]

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    environment:
      IDENTITY_URI: http://identity-service:8081
      CATALOG_URI: http://catalog-service:8082
      INVENTORY_URI: http://inventory-service:8083
      CART_URI: http://cart-service:8084
      ORDER_URI: http://order-service:8085
      PAYMENT_URI: http://payment-service:8086
      JWT_SECRET: ${JWT_SECRET:-replace-with-very-strong-32-char-secret}
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS:-http://localhost,http://localhost:4200,http://localhost:8080,http://127.0.0.1,http://127.0.0.1:8080}
    depends_on: [identity-service, catalog-service, inventory-service, cart-service, order-service, payment-service]

  ui-angular:
    build:
      context: ./ui-angular
      dockerfile: Dockerfile
    ports:
      - "80:80"
      - "8080:80"
    depends_on: [gateway]

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports:
      - "8025:8025"
      - "1025:1025"

volumes:
  pgdata:
